name: E2E (Playwright)

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

jobs:
  e2e:
    name: Playwright E2E
    runs-on: ubuntu-latest
    env:
      COMPOSE_PROJECT_NAME: cleanwithsnapshot-e2e

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create CI .env for compose
        run: |
          cat > .env <<'EOF'
          APP_ENV=dev
          TESTING=true
          POSTGRES_USER=postgres
          POSTGRES_PASSWORD=postgres
          POSTGRES_DB=cleaning
          DATABASE_URL=postgresql+psycopg://postgres:postgres@db:5432/cleaning
          NEXT_PUBLIC_API_BASE_URL=http://api:8000
          EOF

      - name: Start Docker Compose stack
        run: |
          docker compose -f docker-compose.yml -f docker-compose.ci.yml up -d --wait db redis api web

      - name: Wait for API healthz
        run: |
          for i in {1..30}; do
            if curl -fsS --max-time 5 http://localhost:8000/healthz > /dev/null; then
              echo "API /healthz is ready"
              exit 0
            fi
            sleep 5
          done
          echo "Timed out waiting for /healthz"
          exit 1

      - name: Apply migrations
        run: |
          docker compose -f docker-compose.yml -f docker-compose.ci.yml exec -T api alembic upgrade head

      - name: Wait for API readyz
        run: |
          diagnostics() {
            echo "==== /readyz (truncated) ===="
            curl -sS http://localhost:8000/readyz | head -c 2000 || true
            echo
            echo "==== docker compose ps ===="
            docker compose -f docker-compose.yml -f docker-compose.ci.yml ps || true
            echo "==== api logs (tail 300) ===="
            docker compose -f docker-compose.yml -f docker-compose.ci.yml logs --no-color --tail=300 api || true
            echo "==== db logs (tail 300) ===="
            docker compose -f docker-compose.yml -f docker-compose.ci.yml logs --no-color --tail=300 db || true
            echo "==== jobs logs (tail 300) ===="
            docker compose -f docker-compose.yml -f docker-compose.ci.yml logs --no-color --tail=300 jobs || true
            echo "==== db pg_isready ===="
            docker compose -f docker-compose.yml -f docker-compose.ci.yml exec -T db pg_isready -U postgres || true
            echo "==== api env ===="
            docker compose -f docker-compose.yml -f docker-compose.ci.yml exec -T api python -c \"import os; print('APP_ENV', os.getenv('APP_ENV'))\" || true
          }
          for i in {1..30}; do
            if curl -fsS --max-time 5 http://localhost:8000/readyz > /dev/null; then
              echo "API /readyz is ready"
              exit 0
            fi
            if (( i % 6 == 0 )); then
              echo "Still waiting for /readyz... attempt ${i}"
              curl -sS http://localhost:8000/readyz | head -c 2000 || true
              echo
            fi
            sleep 5
          done
          echo "Timed out waiting for /readyz"
          diagnostics
          exit 1

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: web/.nvmrc

      - name: Install web dependencies
        working-directory: web
        run: npm ci

      - name: Install Playwright deps (ephemeral)
        working-directory: web
        env:
          PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD: "1"
        run: |
          npm i -D --no-save --no-package-lock @playwright/test playwright

      - name: Run Playwright tests
        working-directory: web
        env:
          PW_CHANNEL: chrome
          PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD: "1"
        run: |
          npx playwright test --config=../e2e/playwright.config.ts --reporter=html

      - name: Upload Playwright report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: web/playwright-report

      - name: Capture compose logs on failure
        if: failure()
        run: |
          docker compose -f docker-compose.yml -f docker-compose.ci.yml ps > compose-ps.txt
          docker compose -f docker-compose.yml -f docker-compose.ci.yml logs --no-color > compose.log

      - name: Upload compose logs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: compose-e2e-logs
          path: |
            compose.log
            compose-ps.txt

      - name: Tear down Docker Compose stack
        if: always()
        run: |
          docker compose -f docker-compose.yml -f docker-compose.ci.yml down -v

      - name: Cleanup CI .env
        if: always()
        run: rm -f .env
