import urllib.parse
from typing import Any

from fastapi import Request

SUPPORTED_LANGS = {"en", "ru"}
DEFAULT_LANG = "en"

_TRANSLATIONS: dict[str, dict[str, str]] = {
    "en": {
        "nav.dashboard": "Dashboard",
        "nav.my_jobs": "My Jobs",
        "worker.today": "Today",
        "worker.next_job": "Next job",
        "worker.no_jobs": "No jobs assigned.",
        "job.details_title": "Job",
        "job.starts_at": "Starts at",
        "job.duration": "Duration",
        "time.title": "Time tracking",
        "time.planned": "Planned",
        "time.actual": "Actual",
        "time.state": "State",
        "time.start": "Start",
        "time.pause": "Pause",
        "time.resume": "Resume",
        "time.finish": "Finish",
        "reasons.title": "Reasons",
        "reasons.none": "No reasons captured yet.",
        "scope.title": "Scope & notes",
        "scope.no_scope": "No scope captured.",
        "scope.customer_notes": "Customer notes",
        "addons.title": "Add-ons planned",
        "addons.planned": "Planned add-ons",
        "addons.add": "Add add-on",
        "addons.qty": "Quantity",
        "addons.none": "No add-ons planned.",
        "evidence.title": "Evidence required",
        "evidence.standard": "Standard before/after photos recommended.",
        "admin.observability.title": "Admin — Leads, Cases & Dialogs",
        "admin.nav.observability": "Observability",
        "admin.nav.invoices": "Invoices",
        "admin.nav.workers": "Workers",
        "admin.nav.teams": "Teams",
        "admin.nav.clients": "Clients",
        "admin.nav.dispatch": "Dispatch",
        "admin.sections.cases": "Cases",
        "admin.sections.leads": "Leads",
        "admin.sections.dialogs": "Dialogs",
        "admin.sections.transcript": "Transcript",
        "admin.filters.title": "Quick filters:",
        "admin.filters.needs_human": "Needs human",
        "admin.filters.waiting_for_contact": "Waiting for contact",
        "admin.filters.order_created": "Order created",
        "admin.filters.clear": "Clear",
        "admin.empty.leads": "No leads match the current filter.",
        "admin.empty.cases": "No cases match the current filter.",
        "admin.empty.dialogs": "No dialogs match the current filter.",
        "admin.empty.transcript": "No transcript available",
        "admin.leads.created_at": "Created {created}",
        "admin.leads.notes": "Notes: {notes}",
        "admin.cases.default_summary": "Escalated case",
        "admin.labels.reason": "Reason:",
        "admin.cases.created_at": "Created {created}",
        "admin.cases.view_detail": "View detail",
        "admin.labels.conversation": "Conversation",
        "admin.dialogs.no_messages": "No messages yet",
        "admin.dialogs.last_message": "Last message",
        "admin.dialogs.updated": "Updated",
        "admin.buttons.copy": "Copy",
        "admin.contact.phone": "Phone",
        "admin.contact.email": "Email",
        "admin.buttons.mark_contacted": "Mark contacted",
        "admin.labels.case_id": "Case ID",
        "admin.workers.title": "Workers",
        "admin.workers.subtitle": "Manage field staff and assign them to jobs",
        "admin.workers.search": "Search name, phone or email",
        "admin.workers.active_only": "Active only",
        "admin.workers.active_state": "Active state",
        "admin.workers.create": "New worker",
        "admin.workers.details": "Details",
        "admin.workers.name": "Name",
        "admin.workers.phone": "Phone",
        "admin.workers.password": "Password",
        "admin.workers.password_placeholder": "Minimum 8 characters",
        "admin.workers.password_hint": "Leave blank to keep current password",
        "admin.workers.email": "Email",
        "admin.workers.team": "Team",
        "admin.workers.role": "Role",
        "admin.workers.hourly_rate": "Hourly rate (cents)",
        "admin.workers.is_active": "Active",
        "admin.workers.save": "Save worker",
        "admin.workers.status_active": "Active",
        "admin.workers.status_inactive": "Inactive",
        "admin.workers.status_archived": "Archived",
        "admin.workers.status_label": "Status",
        "admin.workers.status_all": "All",
        "admin.workers.availability": "Availability",
        "admin.workers.availability_all": "All",
        "admin.workers.availability_free": "Free now",
        "admin.workers.availability_busy": "Busy now",
        "admin.workers.free_now": "Free now",
        "admin.workers.busy_now": "Busy now",
        "admin.workers.skills": "Skills",
        "admin.workers.rating": "Rating",
        "admin.workers.rating_min": "Rating min",
        "admin.workers.rating_max": "Rating max",
        "admin.workers.busy_until": "Busy until",
        "admin.workers.actions": "Actions",
        "admin.workers.contact": "Contact",
        "admin.workers.none": "No workers match these filters.",
        "admin.workers.archive": "Archive",
        "admin.workers.unarchive": "Unarchive",
        "admin.workers.delete_permanent": "Delete permanently",
        "admin.workers.edit": "Edit",
        "admin.workers.completed_bookings": "Completed bookings",
        "admin.workers.cancelled_bookings": "Cancelled bookings",
        "admin.workers.avg_ticket": "Avg ticket",
        "admin.workers.working_since": "Working since",
        "admin.workers.quick_actions": "Quick actions",
        "admin.workers.assign": "Assign",
        "admin.workers.export_csv": "Export CSV",
        "admin.workers.export_json": "Export JSON",
        "admin.workers.edit_skills_rating": "Edit skills & rating",
        "admin.workers.skills_hint": "Comma-separated skills (e.g., deep clean, windows).",
        "admin.workers.weekly_schedule": "Weekly schedule",
        "admin.workers.next_7_days": "Next 7 days",
        "admin.workers.schedule_date": "Date",
        "admin.workers.schedule_time": "Time",
        "admin.workers.schedule_duration": "Duration (min)",
        "admin.workers.schedule_client": "Client",
        "admin.workers.schedule_status": "Status",
        "admin.workers.schedule_empty": "No bookings scheduled in the next 7 days.",
        "admin.workers.delete_title": "Delete worker",
        "admin.workers.delete_description": "Choose how to handle bookings before deleting this worker.",
        "admin.workers.delete_primary_count": "Primary assignments",
        "admin.workers.delete_crew_count": "Crew assignments",
        "admin.workers.delete_confirm_label": "Type DELETE to confirm",
        "admin.workers.delete_detach_title": "Detach & delete",
        "admin.workers.delete_detach_hint": "Remove this worker from bookings, keep bookings intact.",
        "admin.workers.delete_detach_action": "Detach & delete",
        "admin.workers.delete_cascade_title": "Cascade delete",
        "admin.workers.delete_cascade_hint": "Delete all bookings that reference this worker.",
        "admin.workers.delete_cascade_action": "Delete worker & bookings",
        "admin.teams.title": "Teams",
        "admin.teams.subtitle": "Manage dispatch teams",
        "admin.teams.name": "Team name",
        "admin.teams.create": "Create team",
        "admin.teams.created_at": "Created",
        "admin.teams.none": "No teams yet.",
        "admin.teams.edit": "Edit",
        "admin.teams.save": "Save team",
        "admin.teams.actions": "Actions",
        "admin.teams.workers_count": "Workers",
        "admin.teams.bookings_count": "Bookings",
        "admin.teams.status_label": "Status",
        "admin.teams.status_active": "Active",
        "admin.teams.status_archived": "Archived",
        "admin.teams.details_title": "Team details",
        "admin.teams.details_workers": "Workers",
        "admin.teams.details_bookings": "Bookings",
        "admin.teams.archive_title": "Archive team",
        "admin.teams.archive": "Archive",
        "admin.teams.unarchive": "Unarchive",
        "admin.teams.archive_hint": "Archiving hides the team from active lists and scheduling.",
        "admin.teams.unarchive_hint": "Restore this team to active lists and scheduling.",
        "admin.teams.delete_title": "Delete team",
        "admin.teams.delete_hint": "Type DELETE to confirm deletion.",
        "admin.teams.delete_confirm_hint": "You will choose a deletion strategy on the next screen.",
        "admin.teams.delete_description": "Choose how to handle workers and bookings before deleting this team.",
        "admin.teams.delete_confirm_label": "Type DELETE to confirm",
        "admin.teams.delete_empty_title": "Delete empty team",
        "admin.teams.delete_empty_hint": "This team has no workers or bookings.",
        "admin.teams.delete_action": "Delete",
        "admin.teams.delete_blocked": "Team not empty. Reassign workers and bookings before deleting.",
        "admin.teams.reassign_title": "Reassign & delete",
        "admin.teams.reassign_hint": "Move workers and bookings to another team, then delete this team.",
        "admin.teams.reassign_target": "Move to team",
        "admin.teams.reassign_action": "Reassign & delete",
        "admin.teams.reassign_missing": "Create another team before reassigning.",
        "admin.teams.cascade_title": "Cascade delete",
        "admin.teams.cascade_hint": "Delete all bookings and workers in this team.",
        "admin.teams.cascade_action": "Delete team, bookings & workers",
        "admin.clients.title": "Clients",
        "admin.clients.subtitle": "Manage customer contacts",
        "admin.clients.search": "Search name, phone or email",
        "admin.clients.create": "New client",
        "admin.clients.name": "Name",
        "admin.clients.phone": "Phone",
        "admin.clients.email": "Email",
        "admin.clients.address": "Address",
        "admin.clients.notes": "Notes",
        "admin.clients.save": "Save client",
        "admin.clients.none": "No clients match these filters.",
        "admin.clients.actions": "Actions",
        "admin.clients.status_label": "Status",
        "admin.clients.status_active": "Active",
        "admin.clients.status_archived": "Archived",
        "admin.clients.status_blocked": "Blocked",
        "admin.clients.status_unblocked": "Unblocked",
        "admin.clients.archive": "Archive",
        "admin.clients.archive_client": "Archive client",
        "admin.clients.archive_confirm": "Archive this client?",
        "admin.clients.archive_help": "Archiving hides the client from active lists and booking selection.",
        "admin.clients.unarchive": "Unarchive",
        "admin.clients.unarchive_client": "Unarchive client",
        "admin.clients.unarchive_confirm": "Restore this client?",
        "admin.clients.unarchive_help": "Restore the client to active lists and booking selection.",
        "admin.clients.delete_client": "Delete client permanently",
        "admin.clients.danger_zone": "Danger zone",
        "admin.clients.details_title": "Client card",
        "admin.clients.registered_at": "Date registered",
        "admin.clients.last_booking": "Last booking",
        "admin.clients.quick_actions": "Quick actions",
        "admin.clients.create_booking": "Create booking",
        "admin.clients.block": "Block",
        "admin.clients.unblock": "Unblock",
        "admin.clients.tags_title": "Tags",
        "admin.clients.tags_hint": "Comma-separated tags (e.g., VIP, problematic).",
        "admin.clients.tags_save": "Save tags",
        "admin.clients.tags_none": "No tags yet.",
        "admin.clients.bookings_title": "Bookings history",
        "admin.clients.bookings_total": "Total bookings",
        "admin.clients.bookings_completed": "Completed",
        "admin.clients.bookings_cancelled": "Cancelled",
        "admin.clients.bookings_none": "No bookings yet.",
        "admin.clients.bookings_view": "View booking",
        "admin.clients.bookings_date": "Date",
        "admin.clients.bookings_status": "Status",
        "admin.clients.bookings_duration": "Duration (min)",
        "admin.clients.bookings_amount": "Amount",
        "admin.clients.bookings_team": "Team",
        "admin.clients.bookings_workers": "Assigned workers",
        "admin.clients.bookings_actions": "Actions",
        "admin.clients.notes_title": "Notes",
        "admin.clients.notes_hint": "Latest notes from managers.",
        "admin.clients.notes_none": "No notes yet.",
        "admin.clients.notes_add": "Add note",
        "admin.clients.notes_placeholder": "Add a note...",
        "admin.bookings.title": "Create Booking",
        "admin.bookings.subtitle": "Create a new booking from admin",
        "admin.bookings.team": "Team",
        "admin.bookings.client": "Client",
        "admin.bookings.select_client": "Select existing client",
        "admin.bookings.worker": "Assigned Worker (optional)",
        "admin.bookings.starts_at": "Start Date & Time",
        "admin.bookings.duration": "Duration (minutes)",
        "admin.bookings.address": "Address",
        "admin.bookings.notes": "Notes",
        "admin.bookings.save": "Create Booking",
        "admin.dispatch.title": "Dispatch",
        "admin.dispatch.subtitle": "Assign workers to bookings",
        "admin.dispatch.date_label": "Date",
        "admin.dispatch.assign": "Assign",
        "admin.dispatch.unassigned": "Unassigned",
        "admin.dispatch.assigned_worker": "Assigned worker",
        "admin.dispatch.assigned_workers": "Assigned workers",
        "admin.dispatch.team": "Team",
        "admin.dispatch.time": "Time",
        "admin.dispatch.customer": "Customer",
        "admin.dispatch.status": "Status",
        "admin.dispatch.save": "Save",
        "admin.dispatch.success": "Assignment updated",
        "worker.assigned_worker": "Assigned worker",
        "worker.unassigned": "Unassigned",
    },
    "ru": {
        "nav.dashboard": "Панель",
        "nav.my_jobs": "Мои заказы",
        "worker.today": "Сегодня",
        "worker.next_job": "Следующее задание",
        "worker.no_jobs": "Нет заданий",
        "job.details_title": "Детали задания",
        "job.starts_at": "Начало",
        "job.duration": "Длительность",
        "time.title": "Учёт времени",
        "time.planned": "План",
        "time.actual": "Факт",
        "time.state": "Статус",
        "time.start": "Начать",
        "time.pause": "Пауза",
        "time.resume": "Продолжить",
        "time.finish": "Завершить",
        "reasons.title": "Причины",
        "reasons.none": "Причины не зафиксированы.",
        "scope.title": "Объем работ",
        "scope.no_scope": "Объем не указан.",
        "scope.customer_notes": "Заметки клиента",
        "addons.title": "Дополнения",
        "addons.planned": "Запланированные дополнения",
        "addons.add": "Добавить дополнение",
        "addons.qty": "Количество",
        "addons.none": "Дополнения отсутствуют.",
        "evidence.title": "Фотоотчет",
        "evidence.standard": "Рекомендуются стандартные фото до/после.",
        "admin.observability.title": "Админ — Наблюдение",
        "admin.nav.observability": "Наблюдение",
        "admin.nav.invoices": "Счета",
        "admin.nav.workers": "Сотрудники",
        "admin.nav.teams": "Команды",
        "admin.nav.clients": "Клиенты",
        "admin.nav.dispatch": "Диспетчер",
        "admin.sections.cases": "Случаи",
        "admin.sections.leads": "Лиды",
        "admin.sections.dialogs": "Диалоги",
        "admin.sections.transcript": "Транскрипт",
        "admin.filters.title": "Быстрые фильтры:",
        "admin.filters.needs_human": "Требует человека",
        "admin.filters.waiting_for_contact": "Ожидает контакта",
        "admin.filters.order_created": "Заказ создан",
        "admin.filters.clear": "Сбросить",
        "admin.empty.leads": "Нет лидов, соответствующих фильтру.",
        "admin.empty.cases": "Нет случаев, соответствующих фильтру.",
        "admin.empty.dialogs": "Нет диалогов, соответствующих фильтру.",
        "admin.empty.transcript": "Транскрипт недоступен",
        "admin.leads.created_at": "Создано {created}",
        "admin.leads.notes": "Заметки: {notes}",
        "admin.cases.default_summary": "Эскалированный случай",
        "admin.labels.reason": "Причина:",
        "admin.cases.created_at": "Создано {created}",
        "admin.cases.view_detail": "Детали",
        "admin.labels.conversation": "Диалог",
        "admin.dialogs.no_messages": "Сообщений нет",
        "admin.dialogs.last_message": "Последнее сообщение",
        "admin.dialogs.updated": "Обновлено",
        "admin.buttons.copy": "Копировать",
        "admin.contact.phone": "Телефон",
        "admin.contact.email": "Email",
        "admin.buttons.mark_contacted": "Отметить как связались",
        "admin.labels.case_id": "ID случая",
        "admin.workers.title": "Сотрудники",
        "admin.workers.subtitle": "Управляйте командой и назначайте задания",
        "admin.workers.search": "Поиск по имени, телефону или email",
        "admin.workers.active_only": "Только активные",
        "admin.workers.active_state": "Статус активности",
        "admin.workers.create": "Новый сотрудник",
        "admin.workers.details": "Детали",
        "admin.workers.name": "Имя",
        "admin.workers.phone": "Телефон",
        "admin.workers.password": "Пароль",
        "admin.workers.password_placeholder": "Минимум 8 символов",
        "admin.workers.password_hint": "Оставьте пустым, чтобы сохранить текущий пароль",
        "admin.workers.email": "Email",
        "admin.workers.team": "Команда",
        "admin.workers.role": "Роль",
        "admin.workers.hourly_rate": "Ставка (центов в час)",
        "admin.workers.is_active": "Активен",
        "admin.workers.save": "Сохранить",
        "admin.workers.status_active": "Активен",
        "admin.workers.status_inactive": "Неактивен",
        "admin.workers.status_archived": "Архив",
        "admin.workers.status_label": "Статус",
        "admin.workers.status_all": "Все",
        "admin.workers.availability": "Доступность",
        "admin.workers.availability_all": "Все",
        "admin.workers.availability_free": "Свободен сейчас",
        "admin.workers.availability_busy": "Занят сейчас",
        "admin.workers.free_now": "Свободен сейчас",
        "admin.workers.busy_now": "Занят сейчас",
        "admin.workers.skills": "Навыки",
        "admin.workers.rating": "Рейтинг",
        "admin.workers.rating_min": "Рейтинг от",
        "admin.workers.rating_max": "Рейтинг до",
        "admin.workers.busy_until": "Занят до",
        "admin.workers.actions": "Действия",
        "admin.workers.contact": "Контакты",
        "admin.workers.none": "Нет сотрудников по выбранным фильтрам.",
        "admin.workers.archive": "Архивировать",
        "admin.workers.unarchive": "Разархивировать",
        "admin.workers.delete_permanent": "Удалить навсегда",
        "admin.workers.edit": "Редактировать",
        "admin.workers.completed_bookings": "Завершённые брони",
        "admin.workers.cancelled_bookings": "Отменённые брони",
        "admin.workers.avg_ticket": "Средний чек",
        "admin.workers.working_since": "Работает с",
        "admin.workers.quick_actions": "Быстрые действия",
        "admin.workers.assign": "Назначить",
        "admin.workers.export_csv": "Экспорт CSV",
        "admin.workers.export_json": "Экспорт JSON",
        "admin.workers.edit_skills_rating": "Правка навыков и рейтинга",
        "admin.workers.skills_hint": "Навыки через запятую (например, deep clean, windows).",
        "admin.workers.weekly_schedule": "Расписание на неделю",
        "admin.workers.next_7_days": "Ближайшие 7 дней",
        "admin.workers.schedule_date": "Дата",
        "admin.workers.schedule_time": "Время",
        "admin.workers.schedule_duration": "Длительность (мин)",
        "admin.workers.schedule_client": "Клиент",
        "admin.workers.schedule_status": "Статус",
        "admin.workers.schedule_empty": "Нет бронирований на ближайшие 7 дней.",
        "admin.workers.delete_title": "Удалить сотрудника",
        "admin.workers.delete_description": "Выберите, как обработать брони перед удалением сотрудника.",
        "admin.workers.delete_primary_count": "Основные назначения",
        "admin.workers.delete_crew_count": "Назначения в бригаде",
        "admin.workers.delete_confirm_label": "Введите DELETE для подтверждения",
        "admin.workers.delete_detach_title": "Отвязать и удалить",
        "admin.workers.delete_detach_hint": "Уберите сотрудника из броней, сохранив брони.",
        "admin.workers.delete_detach_action": "Отвязать и удалить",
        "admin.workers.delete_cascade_title": "Каскадное удаление",
        "admin.workers.delete_cascade_hint": "Удалить все брони, где участвует сотрудник.",
        "admin.workers.delete_cascade_action": "Удалить сотрудника и брони",
        "admin.teams.title": "Команды",
        "admin.teams.subtitle": "Управление командами диспетчеров",
        "admin.teams.name": "Название команды",
        "admin.teams.create": "Создать команду",
        "admin.teams.created_at": "Создано",
        "admin.teams.none": "Команды пока не созданы.",
        "admin.teams.edit": "Редактировать",
        "admin.teams.save": "Сохранить команду",
        "admin.teams.actions": "Действия",
        "admin.teams.workers_count": "Сотрудники",
        "admin.teams.bookings_count": "Брони",
        "admin.teams.status_label": "Статус",
        "admin.teams.status_active": "Активные",
        "admin.teams.status_archived": "Архивные",
        "admin.teams.details_title": "Детали команды",
        "admin.teams.details_workers": "Сотрудники",
        "admin.teams.details_bookings": "Брони",
        "admin.teams.archive_title": "Архив команды",
        "admin.teams.archive": "Архивировать",
        "admin.teams.unarchive": "Разархивировать",
        "admin.teams.archive_hint": "Архив скрывает команду из активных списков и расписания.",
        "admin.teams.unarchive_hint": "Вернуть команду в активные списки и расписание.",
        "admin.teams.delete_title": "Удалить команду",
        "admin.teams.delete_hint": "Введите DELETE для подтверждения удаления.",
        "admin.teams.delete_confirm_hint": "На следующем шаге нужно выбрать стратегию удаления.",
        "admin.teams.delete_description": "Выберите, как обработать сотрудников и брони перед удалением команды.",
        "admin.teams.delete_confirm_label": "Введите DELETE для подтверждения",
        "admin.teams.delete_empty_title": "Удалить пустую команду",
        "admin.teams.delete_empty_hint": "В команде нет сотрудников или броней.",
        "admin.teams.delete_action": "Удалить",
        "admin.teams.delete_blocked": "Команда не пуста. Сначала переназначьте сотрудников и брони.",
        "admin.teams.reassign_title": "Переназначить и удалить",
        "admin.teams.reassign_hint": "Перенесите сотрудников и брони в другую команду, затем удалите эту.",
        "admin.teams.reassign_target": "Переназначить в команду",
        "admin.teams.reassign_action": "Переназначить и удалить",
        "admin.teams.reassign_missing": "Создайте другую команду перед переносом.",
        "admin.teams.cascade_title": "Каскадное удаление",
        "admin.teams.cascade_hint": "Удалить все брони и сотрудников команды.",
        "admin.teams.cascade_action": "Удалить команду, брони и сотрудников",
        "admin.clients.title": "Клиенты",
        "admin.clients.subtitle": "Управление контактами клиентов",
        "admin.clients.search": "Поиск по имени, телефону или email",
        "admin.clients.create": "Новый клиент",
        "admin.clients.name": "Имя",
        "admin.clients.phone": "Телефон",
        "admin.clients.email": "Email",
        "admin.clients.address": "Адрес",
        "admin.clients.notes": "Заметки",
        "admin.clients.save": "Сохранить",
        "admin.clients.none": "Нет клиентов по выбранным фильтрам.",
        "admin.clients.actions": "Действия",
        "admin.clients.status_label": "Статус",
        "admin.clients.status_active": "Активен",
        "admin.clients.status_archived": "Архив",
        "admin.clients.status_blocked": "Заблокирован",
        "admin.clients.status_unblocked": "Не заблокирован",
        "admin.clients.archive": "Архивировать",
        "admin.clients.archive_client": "Архивировать клиента",
        "admin.clients.archive_confirm": "Архивировать этого клиента?",
        "admin.clients.archive_help": "Архивация скрывает клиента из активных списков и выбора при бронировании.",
        "admin.clients.unarchive": "Восстановить",
        "admin.clients.unarchive_client": "Восстановить клиента",
        "admin.clients.unarchive_confirm": "Восстановить этого клиента?",
        "admin.clients.unarchive_help": "Вернуть клиента в активные списки и выбор при бронировании.",
        "admin.clients.danger_zone": "Опасная зона",
        "admin.clients.delete_client": "Удалить клиента навсегда",
        "admin.clients.details_title": "Карточка клиента",
        "admin.clients.registered_at": "Дата регистрации",
        "admin.clients.last_booking": "Последнее бронирование",
        "admin.clients.quick_actions": "Быстрые действия",
        "admin.clients.create_booking": "Создать бронирование",
        "admin.clients.block": "Заблокировать",
        "admin.clients.unblock": "Разблокировать",
        "admin.clients.tags_title": "Теги",
        "admin.clients.tags_hint": "Теги через запятую (например, VIP, problematic).",
        "admin.clients.tags_save": "Сохранить теги",
        "admin.clients.tags_none": "Тегов пока нет.",
        "admin.clients.bookings_title": "История бронирований",
        "admin.clients.bookings_total": "Всего бронирований",
        "admin.clients.bookings_completed": "Завершены",
        "admin.clients.bookings_cancelled": "Отменены",
        "admin.clients.bookings_none": "Бронирований пока нет.",
        "admin.clients.bookings_view": "Открыть бронирование",
        "admin.clients.bookings_date": "Дата",
        "admin.clients.bookings_status": "Статус",
        "admin.clients.bookings_duration": "Длительность (мин)",
        "admin.clients.bookings_amount": "Сумма",
        "admin.clients.bookings_team": "Команда",
        "admin.clients.bookings_workers": "Назначенные сотрудники",
        "admin.clients.bookings_actions": "Действия",
        "admin.clients.notes_title": "Заметки",
        "admin.clients.notes_hint": "Последние заметки менеджеров.",
        "admin.clients.notes_none": "Заметок пока нет.",
        "admin.clients.notes_add": "Добавить заметку",
        "admin.clients.notes_placeholder": "Добавьте заметку...",
        "admin.bookings.title": "Создать заказ",
        "admin.bookings.subtitle": "Создание нового заказа из админ-панели",
        "admin.bookings.team": "Команда",
        "admin.bookings.client": "Клиент",
        "admin.bookings.select_client": "Выберите существующего клиента",
        "admin.bookings.worker": "Назначенный сотрудник (необязательно)",
        "admin.bookings.starts_at": "Дата и время начала",
        "admin.bookings.duration": "Длительность (минуты)",
        "admin.bookings.address": "Адрес",
        "admin.bookings.notes": "Заметки",
        "admin.bookings.save": "Создать заказ",
        "admin.dispatch.title": "Диспетчер",
        "admin.dispatch.subtitle": "Назначение сотрудников на заказы",
        "admin.dispatch.date_label": "Дата",
        "admin.dispatch.assign": "Назначить",
        "admin.dispatch.unassigned": "Без назначения",
        "admin.dispatch.assigned_worker": "Назначенный сотрудник",
        "admin.dispatch.assigned_workers": "Назначенные сотрудники",
        "admin.dispatch.team": "Команда",
        "admin.dispatch.time": "Время",
        "admin.dispatch.customer": "Клиент",
        "admin.dispatch.status": "Статус",
        "admin.dispatch.save": "Сохранить",
        "admin.dispatch.success": "Назначение обновлено",
        "worker.assigned_worker": "Назначенный сотрудник",
        "worker.unassigned": "Без назначения",
    },
}


def validate_lang(lang: str | None) -> str | None:
    if not lang:
        return None
    normalized = lang.strip().lower()
    if normalized.startswith("en"):
        return "en"
    if normalized.startswith("ru"):
        return "ru"
    return None


def _resolve_accept_language(header_value: str | None) -> str | None:
    if not header_value:
        return None
    for raw in header_value.split(","):
        candidate = validate_lang(raw.split(";", 1)[0])
        if candidate:
            return candidate
    return None


def resolve_lang(request: Request) -> str:
    cookie_lang = validate_lang(request.cookies.get("ui_lang"))
    if cookie_lang:
        request.state.ui_lang = cookie_lang
        return cookie_lang

    header_lang = _resolve_accept_language(request.headers.get("accept-language"))
    if header_lang:
        request.state.ui_lang = header_lang
        return header_lang

    request.state.ui_lang = DEFAULT_LANG
    return DEFAULT_LANG


def tr(lang: str | None, key: str, **fmt: Any) -> str:
    target_lang = validate_lang(lang) or DEFAULT_LANG
    template = _TRANSLATIONS.get(target_lang, {}).get(key)
    if template is None and target_lang != DEFAULT_LANG:
        template = _TRANSLATIONS.get(DEFAULT_LANG, {}).get(key)
    value = template if template is not None else key
    if fmt:
        try:
            value = value.format(**fmt)
        except Exception:
            return value
    return value


def _current_path(request: Request) -> str:
    filtered = [
        (key, value)
        for key, value in request.query_params.multi_items()
        if key.lower() not in {"lang", "ui_lang"}
    ]
    query = urllib.parse.urlencode(filtered, doseq=True)
    if query:
        return f"{request.url.path}?{query}"
    return request.url.path


def render_lang_toggle(request: Request, lang: str | None = None) -> str:
    current_lang = validate_lang(lang) or resolve_lang(request)
    next_path = _current_path(request)
    if not next_path.startswith("/"):
        next_path = "/"
    encoded_next = urllib.parse.quote(next_path, safe="/")
    links: list[str] = []
    for code, label in [("en", "EN"), ("ru", "RU")]:
        href = f"/ui/lang?lang={code}&next={encoded_next}"
        css_class = "lang-link lang-link-active" if current_lang == code else "lang-link"
        links.append(f'<a class="{css_class}" href="{href}">{label}</a>')
    return " | ".join(links)
