# SaaS migrations playbook

Эти шаги помогают перевести уже работающую инсталляцию из однопользовательского режима к многотенантной модели с организациями.

## 1. Подготовить Default-организацию
1. Убедитесь, что есть запись `organizations` с фиксированным `org_id = 00000000-0000-0000-0000-000000000001`. Миграция `0034_org_id_uuid_and_default_org` создаёт её автоматически и добавляет запись в `organization_billing`.
2. Для существующих администраторов создайте `users` и `memberships`, выдав роли `owner/admin/dispatcher/finance` по необходимости.
3. Обновите переменные окружения, чтобы новые токены JWT содержали `org_id` и совпадали с созданными пользователями.

## 2. Привязать бизнес-данные к org_id (Sprint 2)
1. Остановите приложение и сделайте бэкап базы данных.
2. Примените миграцию `0035_core_tables_org_id`, которая добавляет `org_id` в ключевые таблицы (`teams`, `bookings`, `leads`, `invoices`, `invoice_payments`, `workers`, `documents`, `order_photos`, `subscriptions`, `disputes`, `financial_adjustment_events`, `admin_audit_logs`, `export_events`, `email_events`).
   - Шаги внутри миграции: добавить столбец с временным default, выполнить backfill на `DEFAULT_ORG_ID`, навесить FK на `organizations.org_id`, сделать столбец `NOT NULL`, создать индексы `org_id` и составные (org_id + status/created_at/starts_at).
   - При необходимости повторно применить миграцию на пустой БД — она сама создаст запись `Default Org` и не упадёт, если данные уже в нужном состоянии.
3. После обновления кода проверьте, что SQLAlchemy модели используют `UUID_TYPE` и столбцы `org_id` соответствуют схеме.

## 3. Прогнать миграции и проверить запросы
1. Выполните `alembic upgrade head` после обновления кода.
2. Проверьте, что все API-приложения добавляют `org_id` в создаваемые записи и фильтруют выборки по нему. Для SaaS-трафика не допускайте «тихого» дефолта — org_id должен быть передан явно.
3. Убедитесь, что публичные токены (инвойсы, ссылки) учитывают `org_id` и не пересекаются между организациями.

## 4. Smoke-тест
1. Выполните быстрый сценарий: войти как админ, создать заказ, выставить инвойс и оплатить его в рамках новой организации.
2. Создайте вторую организацию и убедитесь, что данные первой не видны ни в админке, ни в воркер-портале.
3. Запустите `pytest -q`, чтобы проверить автоматические тесты из репозитория.

## 5. Роллбек-план
- Если миграция прошла неуспешно, восстановите БД из бэкапа.
- Для частичного отката используйте `alembic downgrade 0034_org_id_uuid_and_default_org` после резервного копирования и убедитесь, что приложению не требуются столбцы `org_id` в бизнес-таблицах.
- Проверьте, что конфигурация окружения указывает на правильные org_id и секреты JWT.

## Примечания
- Не изменяйте `package.json` и `package-lock.json` в рамках миграции.
- Публичный UI инвойсов остаётся на английском, даже после включения новых организаций.
- После Sprint 2 предполагается убрать автоматические server default для org_id на уровне приложения и требовать явного контекста организации.
